<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bazel in Apollo &mdash; Apollo Auto alpha 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/cyber/doxy-docs/source/main_stylesheet.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script src="../../_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Bridge Header Protocol" href="bridge_header_protocol.html" />
    <link rel="prev" title="Apollo安全更新SDK" href="apollo_secure_upgrade_user_guide_cn.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: skyblue" >
            <a href="../../index.html" class="icon icon-home"> Apollo Auto
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Apollo Auto 自述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Apollo Auto 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cyber/doxy-docs/source/index.html">cyber 文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: skyblue" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apollo Auto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Bazel in Apollo</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/specs/bazel_in_apollo_an_overview.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="bazel-in-apollo">
<h1>Bazel in Apollo<a class="headerlink" href="#bazel-in-apollo" title="永久链接至标题"></a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="永久链接至标题"></a></h2>
<p>Apollo uses <a class="reference external" href="https://bazel.build">Bazel</a> as its underlying build system. Bazel
is an open-source build and test tool with a human-readable, high-level build
language suitable for medium and large projects. You may notice the <code class="docutils literal notranslate"><span class="pre">WORKSPACE</span></code>
file under the root directory, and many <code class="docutils literal notranslate"><span class="pre">BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">*.BUILD</span></code>, <code class="docutils literal notranslate"><span class="pre">workspace.bzl</span></code>
files in sub-directories (e.g. <code class="docutils literal notranslate"><span class="pre">third_party</span></code>). They are all Bazel files.</p>
</section>
<section id="bazel-settings-in-apollo">
<h2>Bazel Settings in Apollo<a class="headerlink" href="#bazel-settings-in-apollo" title="永久链接至标题"></a></h2>
<section id="bazelrc">
<h3>bazelrc<a class="headerlink" href="#bazelrc" title="永久链接至标题"></a></h3>
<p>The content of <code class="docutils literal notranslate"><span class="pre">.bazelrc</span></code> (Apollo’s overall Bazel configuration) under the root
directory is as follows as of this writing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="o">-</span><span class="kn">import</span> <span class="o">%</span><span class="n">workspace</span><span class="o">%/</span><span class="n">tools</span><span class="o">/</span><span class="n">bazel</span><span class="o">.</span><span class="n">rc</span>
<span class="k">try</span><span class="o">-</span><span class="kn">import</span> <span class="o">%</span><span class="n">workspace</span><span class="o">%/.</span><span class="n">apollo</span><span class="o">.</span><span class="n">bazelrc</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tools/bazel.rc</span></code> is for general settings, while <code class="docutils literal notranslate"><span class="pre">.apollo.bazelrc</span></code> was generated
with the <code class="docutils literal notranslate"><span class="pre">config</span></code> sub-command of <code class="docutils literal notranslate"><span class="pre">apollo.sh</span></code>:</p>
<p>You can run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./apollo.sh config --interactive
</pre></div>
</div>
<p>to configure it interactively, or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./apollo.sh config --noninteractive
</pre></div>
</div>
<p>should be run to configure it non-interactively.</p>
</section>
<section id="bazelignore">
<h3>.bazelignore<a class="headerlink" href="#bazelignore" title="永久链接至标题"></a></h3>
<p>Besides <code class="docutils literal notranslate"><span class="pre">.bazelrc</span></code>, the <code class="docutils literal notranslate"><span class="pre">.bazelignore</span></code> file under Apollo workspace also governs
Bazel’s behavior. Similar to <code class="docutils literal notranslate"><span class="pre">.gitignore</span></code>, <code class="docutils literal notranslate"><span class="pre">.bazelignore</span></code> is used to specify
directories for Bazel to ignore. Currently, the <code class="docutils literal notranslate"><span class="pre">scripts</span></code>, <code class="docutils literal notranslate"><span class="pre">docker</span></code>, <code class="docutils literal notranslate"><span class="pre">docs</span></code>
directories were specified.</p>
</section>
<section id="bazel-distribution-files-directory">
<h3>Bazel Distribution Files Directory<a class="headerlink" href="#bazel-distribution-files-directory" title="永久链接至标题"></a></h3>
<p>Within <code class="docutils literal notranslate"><span class="pre">.apollo.bazelrc</span></code>, two directories were specified for Bazel:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">startup</span> <span class="o">--</span><span class="n">output_user_root</span><span class="o">=</span><span class="s2">&quot;/apollo/.cache/bazel&quot;</span>
<span class="n">common</span> <span class="o">--</span><span class="n">distdir</span><span class="o">=</span><span class="s2">&quot;/apollo/.cache/distdir&quot;</span>
</pre></div>
</div>
<p>The startup option <code class="docutils literal notranslate"><span class="pre">--output_user_root</span></code> was used to specify Bazel output
directories (Ref:
<a class="reference external" href="https://docs.bazel.build/versions/master/output_directories.html#output-directory-layout">Bazel Docs: Output Directory Layout</a>).
We specify it within Apollo root directory so that it can be mounted into Docker
container by <code class="docutils literal notranslate"><span class="pre">docker/scripts/dev_start.sh</span></code> together with Apollo root directory
on the host.</p>
<p>According to
<a class="reference external" href="https://docs.bazel.build/versions/master/guide.html#distribution-files-directories">Bazel Docs: Distribution Files Directories</a>,</p>
<blockquote>
<div><p>Using the <code class="docutils literal notranslate"><span class="pre">--distdir=/path/to/directory</span></code> option, you can specify additional
read-only directories to look for files instead of fetching them. A file is
taken from such a directory if the file name is equal to the base name of the
URL and additionally the hash of the file is equal to the one specified in the
download request.</p>
</div></blockquote>
<p>Since this option is especially useful for users with not-stable-enough network
connection, Apollo enabled a specific environment variable for that:
<code class="docutils literal notranslate"><span class="pre">APOLLO_BAZEL_DIST_DIR</span></code>. You can configure it in <code class="docutils literal notranslate"><span class="pre">cyber/setup.bash</span></code>, and then
run the following command for it to take effect.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">cyber</span><span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">bash</span>
<span class="o">./</span><span class="n">apollo</span><span class="o">.</span><span class="n">sh</span> <span class="n">config</span> <span class="o">--</span><span class="n">noninteractive</span>
</pre></div>
</div>
</section>
</section>
<section id="bazel-build-test-and-coverage">
<h2>Bazel Build, Test and Coverage<a class="headerlink" href="#bazel-build-test-and-coverage" title="永久链接至标题"></a></h2>
<p>Please refer to
<a class="reference internal" href="apollo_build_and_test_explained.html"><span class="doc std std-doc">Apollo Build and Test Explained</span></a>.</p>
<section id="apollos-special">
<h3>Apollo’s Special<a class="headerlink" href="#apollos-special" title="永久链接至标题"></a></h3>
</section>
<section id="proto-files">
<h3>Proto Files<a class="headerlink" href="#proto-files" title="永久链接至标题"></a></h3>
<p>In Apollo 6.0, we recommend that proto files for each module be placed under
some separate directory, say, <code class="docutils literal notranslate"><span class="pre">modules/a/proto</span></code>.</p>
<p>Then you can run the following command to generate C++ and Python targets for
all the proto files under that directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scripts</span><span class="o">/</span><span class="n">proto_build_generator</span><span class="o">.</span><span class="n">py</span> <span class="n">modules</span><span class="o">/</span><span class="n">a</span><span class="o">/</span><span class="n">proto</span><span class="o">/</span><span class="n">BUILD</span>
</pre></div>
</div>
</section>
<section id="breaking-change-python-files">
<h3>[Breaking Change] Python Files<a class="headerlink" href="#breaking-change-python-files" title="永久链接至标题"></a></h3>
<p>Starting from Apollo 6.0, Python libraries/binaries were also managed by Bazel.</p>
<p>What you do in previous Apollo releases, say,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="o">/</span><span class="n">mapshow</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>, now should be done in either of the following approaches:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bazel</span><span class="o">-</span><span class="nb">bin</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="o">/</span><span class="n">mapshow</span> <span class="c1"># Approach #1</span>
<span class="n">bazel</span> <span class="n">run</span> <span class="n">modules</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">mapshow</span><span class="p">:</span><span class="n">mapshow</span>   <span class="c1"># Approach #2</span>
</pre></div>
</div>
</section>
</section>
<section id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="永久链接至标题"></a></h2>
<p>Please refer to <a class="reference external" href="https://docs.bazel.build">Bazel Docs</a> for more on Bazel.</p>
<p>Thanks for reading!</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="apollo_secure_upgrade_user_guide_cn.html" class="btn btn-neutral float-left" title="Apollo安全更新SDK" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="bridge_header_protocol.html" class="btn btn-neutral float-right" title="Bridge Header Protocol" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2021, xinetzone.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>