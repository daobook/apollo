<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OPEN SPACE TRAJECTORY PARTITION &mdash; Apollo Auto alpha 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/cyber/doxy-docs/source/main_stylesheet.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script src="../../_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="GENERATE FINAL TRAJECTORY" href="open_space_trajectory_provider_en.html" />
    <link rel="prev" title="OPTIMIZE COARSE TRAJECTORY" href="open_space_trajectory_optimizer_en.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: skyblue" >
            <a href="../../index.html" class="icon icon-home"> Apollo Auto
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Apollo Auto 自述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Apollo Auto 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cyber/doxy-docs/source/index.html">cyber 文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: skyblue" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apollo Auto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>OPEN SPACE TRAJECTORY PARTITION</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/technical_documents/open_space_trajectory_partition.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="open-space-trajectory-partition">
<h1>OPEN SPACE TRAJECTORY PARTITION<a class="headerlink" href="#open-space-trajectory-partition" title="永久链接至标题"></a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题"></a></h1>
<p>Apollo planning is scenario based, where each driving use case is treated as a different driving scenario.</p>
<p>Open space trajectory partition task is used to partition and optimize stiched trajectroy obtained from open space trajectory provider task.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="where-is-the-code">
<h1>Where is the code<a class="headerlink" href="#where-is-the-code" title="永久链接至标题"></a></h1>
<p>Please refer <a class="reference external" href="https://github.com/ApolloAuto/apollo/modules/planning/tasks/optimizers/open_space_trajectory_partition/open_space_trajectory_partition.cc">open space trajectory parition</a>.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code-reading">
<h1>Code Reading<a class="headerlink" href="#code-reading" title="永久链接至标题"></a></h1>
<ol>
<li><p>Input : stitched trajectory(without optimization) / vehicle position info.</p></li>
<li><p>The interpolated trajectory is obtained by calling <code class="docutils literal notranslate"><span class="pre">InterpolateTrajectory()</span></code> to increase stitched trajectory points.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">InterpolateTrajectory</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">DiscretizedTrajectory</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stitched_trajectory_result</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DiscretizedTrajectory</span><span class="o">*</span><span class="w"> </span><span class="n">interpolated_trajectory</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>According to the heading angle and traking angle, the gear shift point can be determined.
Use <code class="docutils literal notranslate"><span class="pre">std::vector&lt;TrajGearPair&gt;</span></code> to store gear infomation and trajectory points, then partition trajectory into a group of trajectories from the gear shift point.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">PartitionTrajectory</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DiscretizedTrajectory</span><span class="o">&amp;</span><span class="w"> </span><span class="n">trajectory</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajGearPair</span><span class="o">&gt;*</span><span class="w"> </span><span class="n">partitioned_trajectories</span><span class="p">);</span><span class="w">       </span>
</pre></div>
</div>
</li>
<li><p>If replan due to fallback stop, the position init staus will be set to false.</p>
<p>When replan success, we use <code class="docutils literal notranslate"><span class="pre">AdjustRelativeTimeAndS()</span></code> to adjust partitioned trajectories obtained from step 3.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">AdjustRelativeTimeAndS</span><span class="p">(</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajGearPair</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">partitioned_trajectories</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_trajectory_index</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">closest_trajectory_point_index</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">DiscretizedTrajectory</span><span class="o">*</span><span class="w"> </span><span class="n">stitched_trajectory_result</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">TrajGearPair</span><span class="o">*</span><span class="w"> </span><span class="n">current_partitioned_trajectory</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>When fallback is not required, choose the closest partitioned trajectory to follow.</p>
<ol class="simple">
<li><p>Base on ADC position, heading, body size and velocity info, we get vehicle center point info and moving direction.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">UpdateVehicleInfo</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>Encode partitioned trajectories;</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">EncodeTrajectory</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DiscretizedTrajectory</span><span class="o">&amp;</span><span class="w"> </span><span class="n">trajectory</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">encoding</span><span class="p">);</span><span class="w">     </span>
</pre></div>
</div>
<ol>
<li><p>To find the closest point on trajectory, a search range needed to be determined. It requires the distance between path end point and ADC enter point, the heading search difference and the head track difference all within the threshold.</p>
<p>Base on ADC box and path point box, the IOU(intersection over union) is computed for each path point in the search range.</p>
<p>If the IOU of the trajectory end point is bigger than threshold and partitioned trajectories group has other trajectory can be used, it means ADC reach the end of a trajectory, another trajectory to be used.</p>
<p>Then update trajectory history to store which trajectory has been used.</p>
</li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckReachTrajectoryEnd</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">DiscretizedTrajectory</span><span class="o">&amp;</span><span class="w"> </span><span class="n">trajectory</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="n">canbus</span><span class="o">::</span><span class="n">Chassis</span><span class="o">::</span><span class="n">GearPosition</span><span class="o">&amp;</span><span class="w"> </span><span class="n">gear</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">trajectories_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">trajectories_index</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">current_trajectory_index</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">current_trajectory_point_index</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckTrajTraversed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">trajectory_encoding_to_check</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">UpdateTrajHistory</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">chosen_trajectory_encoding</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol>
<li><p>When there is no need for ADC to switch to next trajectory, use IOU info mentioned above to find the closest trajectory point(the biggest IOU point) to follow.</p></li>
<li><p>If the closest trajectory point doesn’t belong to current trajectory or couldn’t find closest trajectory point due to some unnormal cases, we use <code class="docutils literal notranslate"><span class="pre">UseFailSafeSearch()</span></code> to get a safe trajectory to follow.</p>
<p>When using this function, we only care about distance between path end point and ADC enter point to find the search range, no more limitation on angle difference.</p>
</li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">UseFailSafeSearch</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajGearPair</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">partitioned_trajectories</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">trajectories_encodings</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">current_trajectory_index</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="o">*</span><span class="w"> </span><span class="n">current_trajectory_point_index</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">FLAGS_use_gear_shift_trajectory()</span></code> set to be true, a small part trajectory obtained by calling <code class="docutils literal notranslate"><span class="pre">GenerateGearShiftTrajectory()</span></code> will be added to make vehicle moving smoothly during gear shifting.
Otherwise we use <code class="docutils literal notranslate"><span class="pre">AdjustRelativeTimeAndS()</span></code> to adjust partitioned trajectory.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">InsertGearShiftTrajectory</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">flag_change_to_next</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_trajectory_index</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajGearPair</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">partitioned_trajectories</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TrajGearPair</span><span class="o">*</span><span class="w"> </span><span class="n">gear_switch_idle_time_trajectory</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">GenerateGearShiftTrajectory</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">canbus</span><span class="o">::</span><span class="n">Chassis</span><span class="o">::</span><span class="n">GearPosition</span><span class="o">&amp;</span><span class="w"> </span><span class="n">gear_position</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TrajGearPair</span><span class="o">*</span><span class="w"> </span><span class="n">gear_switch_idle_time_trajectory</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">AdjustRelativeTimeAndS</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajGearPair</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">partitioned_trajectories</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">current_trajectory_index</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">closest_trajectory_point_index</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">DiscretizedTrajectory</span><span class="o">*</span><span class="w"> </span><span class="n">stitched_trajectory_result</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">TrajGearPair</span><span class="o">*</span><span class="w"> </span><span class="n">current_partitioned_trajectory</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Return process status.</p></li>
<li><p>Output: partitioned trajectories.</p></li>
</ol>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="open_space_trajectory_optimizer_en.html" class="btn btn-neutral float-left" title="OPTIMIZE COARSE TRAJECTORY" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="open_space_trajectory_provider_en.html" class="btn btn-neutral float-right" title="GENERATE FINAL TRAJECTORY" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2021, xinetzone.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>