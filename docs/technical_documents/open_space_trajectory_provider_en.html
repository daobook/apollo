<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GENERATE FINAL TRAJECTORY &mdash; Apollo Auto alpha 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/cyber/doxy-docs/source/main_stylesheet.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script src="../../_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="PARKING SCENARIO" href="parking_scenario.html" />
    <link rel="prev" title="OPEN SPACE TRAJECTORY PARTITION" href="open_space_trajectory_partition.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: skyblue" >
            <a href="../../index.html" class="icon icon-home"> Apollo Auto
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Apollo Auto 自述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Apollo Auto 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cyber/doxy-docs/source/index.html">cyber 文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: skyblue" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apollo Auto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>GENERATE FINAL TRAJECTORY</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/technical_documents/open_space_trajectory_provider_en.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="generate-final-trajectory">
<h1>GENERATE FINAL TRAJECTORY<a class="headerlink" href="#generate-final-trajectory" title="永久链接至标题"></a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题"></a></h1>
<p>The goal of this part is to generate the final trajectory in the open space. Open_space_trajectory_provider is very important to control the flow and call the hybrid a star and trajectory smoothing algorithm.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="where-is-the-code">
<h1>Where is the code<a class="headerlink" href="#where-is-the-code" title="永久链接至标题"></a></h1>
<p>Please refer to <a class="reference external" href="https://github.com/ApolloAuto/apollo/tree/master/modules/planning/tasks/optimizers/open_space_trajectory_generation/open_space_trajectory_provider.cc">open_space_trajectory_provider.cc</a></p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code-reading">
<h1>Code Reading<a class="headerlink" href="#code-reading" title="永久链接至标题"></a></h1>
<ol>
<li><p>Input: open_space_trajectory_provider::Process() is called by the OPEN_SPACE_TRAJECTORY_PROVIDER task of VALET_PARKING_PARKING stage, please refer to <a class="reference external" href="https://github.com/ApolloAuto/apollo/blob/master/modules/planning/conf/scenario/valet_parking_config.pb.txt">valet_parking_config.pb.txt</a>.</p></li>
<li><p>There is a stop trajectory which generated in the park and go check stage. In order to ensure safety, it is necessary in this case.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">injector_</span><span class="o">-&gt;</span><span class="n">planning_context</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">-&gt;</span><span class="n">mutable_planning_status</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">-&gt;</span><span class="n">mutable_park_and_go</span><span class="p">()</span><span class="w"></span>
<span class="w">      </span><span class="o">-&gt;</span><span class="n">in_check_stage</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">ADEBUG</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;ParkAndGo Stage Check.&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GenerateStopTrajectory</span><span class="p">(</span><span class="n">trajectory_data</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Status</span><span class="o">::</span><span class="n">OK</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Start thread when getting in Process() for the first time. This will call the GenerateTrajectoryThread() function to plan the first trajectory and will update three kinds of trajectory state: trajectory_updated_, trajectory_skipped_, trajectory_error_.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FLAGS_enable_open_space_planner_thread</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">thread_init_flag_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">task_future_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cyber</span><span class="o">::</span><span class="n">Async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">OpenSpaceTrajectoryProvider</span><span class="o">::</span><span class="n">GenerateTrajectoryThread</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">thread_init_flag_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Whether vehicle is stoped due to fallback is determined by the IsVehicleStopDueToFallBack() function. This determines the final trajectory planning.</p></li>
<li><p>If vehicle is stopped due to fallback, replan stitching trajectory by ComputeReinitStitchingTrajectory() function. If not, replan stitching trajectory by ComputeStitchingTrajectory(), please refer to <a class="reference external" href="https://github.com/ApolloAuto/apollo/blob/master/modules/planning/common/trajectory_stitcher.cc">trajectory_stitcher.cc</a>.</p></li>
<li><p>Generate trajectory depends on the FLAGS_enable_open_space_planner_thread. A stop trajectory is generated in the following cases:</p>
<ol class="simple">
<li><p>Planning thread is stopped.</p></li>
<li><p>The vehicle arrives near the destination.</p></li>
<li><p>trajectory_error_ is triggered for more than 10 seconds.</p></li>
<li><p>Previous frame planning failed.</p></li>
<li><p>If the trajectory can be updated normally, the optimized trajectory is output normally.</p></li>
</ol>
</li>
<li><p>Output: the optput is final trajectory information.</p></li>
</ol>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="algorithm-detail">
<h1>Algorithm Detail<a class="headerlink" href="#algorithm-detail" title="永久链接至标题"></a></h1>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>``` cpp
bool OpenSpaceTrajectoryProvider::IsVehicleStopDueToFallBack(const bool is_on_fallback, 
                                                             const common::VehicleState&amp; vehicle_state)
```
The function is used to judge whether the vehicle is stopped due to fallback.
</pre></div>
</div>
<ol>
<li><p>Parameter: The input parameter is fallback flag of previous frame and vehicle states.</p></li>
<li><p>Introduction: The flag and vehicle state can be used to design the logic.</p></li>
<li><p>Process detail:</p>
<ol class="simple">
<li><p>Fallback flag judgment: if the flag is false, then return false.</p></li>
<li><p>When the vehicle speed and acceleration are less than the threshold, the result is true, indicating that it is caused by fall        back.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajectoryPoint</span><span class="o">&gt;</span><span class="w"> </span><span class="n">TrajectoryStitcher</span><span class="o">::</span><span class="n">ComputeStitchingTrajectory</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">VehicleState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vehicle_state</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">current_timestamp</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">planning_cycle_time</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">preserved_points_num</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">replan_by_offset</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                            </span><span class="k">const</span><span class="w"> </span><span class="n">PublishableTrajectory</span><span class="o">*</span><span class="w"> </span><span class="n">prev_trajectory</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                                            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span><span class="w"> </span><span class="n">replan_reason</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The function is used to stitch trajectory and is used to replan based on some unreasonable case.</p>
</li>
<li><p>Parameter: Vehicle state, current_timestamp, planning cycle time, replan_by_offset, previous trajectory and the reason of replanning.</p></li>
<li><p>Introduction: Handle some unreasonable case by replanning, stitch trajectory and post process.</p></li>
<li><p>Process detail:</p>
<ol class="simple">
<li><p>It will re-plan the trajectory in following cases:</p>
<ol class="simple">
<li><p>Stitching trajectory is disabled by gflag.</p></li>
<li><p>There is no previous trajectory.</p></li>
<li><p>Not in autopilot mode.</p></li>
<li><p>The number of points in the previous frame is zero.</p></li>
<li><p>The current time is less than the trajectory start time of the previous frame.</p></li>
<li><p>The current time is more than the trajetory end time of the previous frame.</p></li>
<li><p>The matching path point is empty.</p></li>
<li><p>The horizontal and vertical deviation of the projection point is greater than the threshold.</p></li>
</ol>
</li>
<li><p>Stitch trajectory according to the planning period and the position of the projection point.</p></li>
<li><p>Determine whether each trajectory point of the stitching trajectory is empty, and if it is empty, it will replan.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">TrajectoryPoint</span><span class="o">&gt;</span><span class="n">TrajectoryStitcher</span><span class="o">::</span><span class="n">ComputeReinitStitchingTrajectory</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">planning_cycle_time</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                                 </span><span class="k">const</span><span class="w"> </span><span class="n">VehicleState</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vehicle_state</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>The function is used to initialize stitching trajectory and get the initial point.</p>
</li>
<li><p>Parameter: The planned cycle time and vehicle state</p></li>
<li><p>Introduction: The function can get the diffrent initial point based on the different logic.</p></li>
<li><p>Process detail:</p>
<ol class="simple">
<li><p>When the vehicle speed and acceleration are less than the threshold, the message of initial point is from vehicle state.           2. When the vehicle speed and acceleration satisfy the threshold, the vehicle state is calculated based on the kinematics model.</p></li>
</ol>
</li>
</ol>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="open_space_trajectory_partition.html" class="btn btn-neutral float-left" title="OPEN SPACE TRAJECTORY PARTITION" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="parking_scenario.html" class="btn btn-neutral float-right" title="PARKING SCENARIO" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2021, xinetzone.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>