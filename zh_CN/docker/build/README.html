<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apollo Docker Image Build Process &mdash; Apollo Auto alpha 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/cyber/doxy-docs/source/main_stylesheet.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script src="../../_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Host Setup" href="../setup_host/README.html" />
    <link rel="prev" title="How to Contribute to Apollo" href="../../CONTRIBUTING.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: skyblue" >
            <a href="../../index.html" class="icon icon-home"> Apollo Auto
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Apollo Auto 自述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../docs/README.html">Apollo Auto 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cyber/doxy-docs/source/index.html">cyber 文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: skyblue" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apollo Auto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Apollo Docker Image Build Process</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docker/build/README.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="apollo-docker-image-build-process">
<h1>Apollo Docker Image Build Process<a class="headerlink" href="#apollo-docker-image-build-process" title="永久链接至标题"></a></h1>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题"></a></h2>
<p>As you may already know, Apollo runs inside Docker container. There are
basically two types of Apollo Docker images: CyberRT and Dev. CyberRT images
were for developers who want to play with the CyberRT framework only, while Dev
images were used to build and run the whole Apollo project.</p>
<p>Currently, two CPU architectures are supported: <code class="docutils literal notranslate"><span class="pre">x86_64</span></code> and <code class="docutils literal notranslate"><span class="pre">aarch64</span></code>.</p>
<p><strong>Note</strong></p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">dev.aarch64</span></code> image was still WIP as of today. It is expected to be ready in
the next few months.</p>
</div></blockquote>
<p>In the section below, I will describe briefly the steps to build these Docker
images.</p>
</section>
<section id="build-cyberrt-image">
<h2>Build CyberRT Image<a class="headerlink" href="#build-cyberrt-image" title="永久链接至标题"></a></h2>
<p>Type <code class="docutils literal notranslate"><span class="pre">./build_docker.sh</span> <span class="pre">-h</span></code> for help message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Usage</span><span class="p">:</span>
    <span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="o">&lt;</span><span class="n">Dockerfile</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">Options</span><span class="p">]</span>
<span class="n">Available</span> <span class="n">options</span><span class="p">:</span>
    <span class="o">-</span><span class="n">c</span><span class="p">,</span><span class="o">--</span><span class="n">clean</span>      <span class="n">Use</span> <span class="s2">&quot;--no-cache=true&quot;</span> <span class="k">for</span> <span class="n">docker</span> <span class="n">build</span>
    <span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="o">--</span><span class="n">mode</span>       <span class="s2">&quot;build&quot;</span> <span class="k">for</span> <span class="n">build</span> <span class="n">everything</span> <span class="kn">from</span> <span class="nn">source</span> <span class="k">if</span> <span class="n">possible</span><span class="p">,</span> <span class="s2">&quot;download&quot;</span> <span class="k">for</span> <span class="n">using</span> <span class="n">prebuilt</span> <span class="n">ones</span>
    <span class="o">-</span><span class="n">g</span><span class="p">,</span><span class="o">--</span><span class="n">geo</span>        <span class="n">Enable</span> <span class="n">geo</span><span class="o">-</span><span class="n">specific</span> <span class="n">mirrors</span> <span class="n">to</span> <span class="n">speed</span> <span class="n">up</span> <span class="n">build</span><span class="o">.</span> <span class="n">Currently</span> <span class="s2">&quot;cn&quot;</span> <span class="ow">and</span> <span class="s2">&quot;us&quot;</span> <span class="n">are</span> <span class="n">supported</span><span class="o">.</span>
    <span class="o">-</span><span class="n">d</span><span class="p">,</span><span class="o">--</span><span class="n">dist</span>       <span class="n">Whether</span> <span class="n">to</span> <span class="n">build</span> <span class="n">stable</span><span class="p">(</span><span class="s2">&quot;stable&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experimental</span><span class="p">(</span><span class="s2">&quot;testing&quot;</span><span class="p">)</span> <span class="n">Docker</span> <span class="n">images</span>
    <span class="o">-</span><span class="n">t</span><span class="p">,</span><span class="o">--</span><span class="n">timestamp</span>  <span class="n">Specify</span> <span class="n">Cyber</span> <span class="n">image</span> <span class="n">timestamp</span> <span class="n">to</span> <span class="n">build</span> <span class="n">Dev</span> <span class="n">image</span> <span class="kn">from</span> <span class="nn">it.</span> <span class="n">Format</span><span class="p">:</span> <span class="n">yyyymmdd_hhmm</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span> <span class="mi">20210205_1520</span><span class="p">)</span>
    <span class="o">--</span><span class="n">dry</span>           <span class="n">Dry</span> <span class="n">run</span> <span class="p">(</span><span class="k">for</span> <span class="n">testing</span> <span class="n">purpose</span><span class="p">)</span>
    <span class="o">-</span><span class="n">h</span><span class="p">,</span><span class="o">--</span><span class="n">help</span>       <span class="n">Show</span> <span class="n">this</span> <span class="n">message</span> <span class="ow">and</span> <span class="n">exit</span>
<span class="n">E</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="p">,</span>
    <span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">cyber</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">dockerfile</span> <span class="o">-</span><span class="n">m</span> <span class="n">build</span> <span class="o">-</span><span class="n">g</span> <span class="n">cn</span>
    <span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">dev</span><span class="o">.</span><span class="n">aarch64</span><span class="o">.</span><span class="n">dockerfile</span> <span class="o">-</span><span class="n">m</span> <span class="n">download</span> <span class="o">-</span><span class="n">d</span> <span class="n">testing</span>
</pre></div>
</div>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">-g/--geo</span></code> option is used to enable geo-location based settings (APT &amp;
PYPI mirrors, etc.). Two codes (<code class="docutils literal notranslate"><span class="pre">us</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">cn</span></code>) are supported now, and the default
is <code class="docutils literal notranslate"><span class="pre">us</span></code>.</p>
<p>To build the latest CyberRT image, simply run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">cyber</span><span class="o">.&lt;</span><span class="n">TARGET_ARCH</span><span class="o">&gt;.</span><span class="n">dockerfile</span>
</pre></div>
</div>
<p>Users of mainland China can specify <code class="docutils literal notranslate"><span class="pre">-g</span> <span class="pre">cn</span></code> to speed up build process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">cyber</span><span class="o">.&lt;</span><span class="n">TARGET_ARCH</span><span class="o">&gt;.</span><span class="n">dockerfile</span> <span class="o">-</span><span class="n">g</span> <span class="n">cn</span>
</pre></div>
</div>
</section>
<section id="build-apollo-dev-image">
<h2>Build Apollo Dev Image<a class="headerlink" href="#build-apollo-dev-image" title="永久链接至标题"></a></h2>
<p>Run the following command to build Apollo Dev image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">dev</span><span class="o">.&lt;</span><span class="n">TARGET_ARCH</span><span class="o">&gt;.</span><span class="n">dockerfile</span>
</pre></div>
</div>
<p>On success, output messages like the following will be shown at the bottom of
your screen.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Successfully</span> <span class="n">built</span> <span class="n">baca71e567e6</span>
<span class="n">Successfully</span> <span class="n">tagged</span> <span class="n">apolloauto</span><span class="o">/</span><span class="n">apollo</span><span class="p">:</span><span class="n">dev</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="mf">18.04</span><span class="o">-</span><span class="mi">20200824_0339</span>
<span class="n">Built</span> <span class="n">new</span> <span class="n">image</span> <span class="n">apolloauto</span><span class="o">/</span><span class="n">apollo</span><span class="p">:</span><span class="n">dev</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="mf">18.04</span><span class="o">-</span><span class="mi">20200824_0339</span>
</pre></div>
</div>
</section>
<section id="build-apollo-runtime-docker-image">
<h2>Build Apollo Runtime Docker Image<a class="headerlink" href="#build-apollo-runtime-docker-image" title="永久链接至标题"></a></h2>
<p>Apollo Runtime Docker was used in combination with Release Build output for easy
deployment. You can run the following commands to build Apollo Runtime Docker
image on your own.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate required APT packages</span>
<span class="o">./</span><span class="n">apollo</span><span class="o">.</span><span class="n">sh</span> <span class="n">release</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">r</span>

<span class="n">cd</span> <span class="n">docker</span><span class="o">/</span><span class="n">build</span>
<span class="c1"># Copy the generated package list for docker build</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">apollo</span><span class="o">/</span><span class="n">output</span><span class="o">/</span><span class="n">syspkgs</span><span class="o">.</span><span class="n">txt</span> <span class="o">.</span>

<span class="n">cp</span> <span class="n">runtime</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">dockerfile</span><span class="o">.</span><span class="n">sample</span> <span class="n">runtime</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">dockerfile</span>
<span class="n">bash</span> <span class="n">build_docker</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">f</span> <span class="n">runtime</span><span class="o">.</span><span class="n">x86_64</span><span class="o">.</span><span class="n">dockerfile</span>
</pre></div>
</div>
<blockquote>
<div><p>Note: Apollo Runtime Docker supports x86_64 only as Release Build was not
ready for Aarch64 yet.</p>
</div></blockquote>
</section>
<section id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="永久链接至标题"></a></h2>
<section id="build-log">
<h3>Build Log<a class="headerlink" href="#build-log" title="永久链接至标题"></a></h3>
<p>The build log for CyberRT and Dev Docker images was located at
<code class="docutils literal notranslate"><span class="pre">/opt/apollo/build.log</span></code>, which contains download links and checksums of
dependent packages during Docker build.</p>
</section>
<section id="enable-local-http-cache-to-speed-up-build">
<h3>Enable Local HTTP Cache to Speed Up Build<a class="headerlink" href="#enable-local-http-cache-to-speed-up-build" title="永久链接至标题"></a></h3>
<p>You can enable local HTTP cache to speed up package downloading by performing
the following steps on your <strong>host</strong> running Docker:</p>
<ol class="simple">
<li><p>Download all prerequisite packages to a directory (say, <code class="docutils literal notranslate"><span class="pre">$HOME/archive</span></code>) with
URLs listed in the build log. Pay attention to their checksum.</p></li>
<li><p>Change to that archive directory and start your local HTTP cache server at
port <strong>8388</strong>.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd $HOME/archive
nohup python3 -m http.server 8388 &amp;
</pre></div>
</div>
<blockquote>
<div><p>Note: Another advantage with the local HTTP cache mechanism is, it has little
influence on the final image size. Even if the cached package was missing or
broken, it can still be downloaded from the original URL.</p>
</div></blockquote>
<ol class="simple">
<li><p>Rerun <code class="docutils literal notranslate"><span class="pre">build_docker.sh</span></code>.</p></li>
</ol>
</section>
</section>
<section id="add-new-installer">
<h2>Add New Installer<a class="headerlink" href="#add-new-installer" title="永久链接至标题"></a></h2>
<p>The best practice of a new installer would be:</p>
<ol>
<li><p>Well tested.</p>
<p>Of course. Make it work, and don’t break other installers, such as
incompatible versions of libraries.</p>
</li>
<li><p>Standalone.</p>
<p>Have minimum assumption about the basement, which means, you can depend on
the base image and <code class="docutils literal notranslate"><span class="pre">installers/installer_base.sh</span></code>. Other than that, you
should install all the dependencies in your own installer.</p>
</li>
<li><p>Thin.</p>
<p>It will generate a new layer in the final image, so please keep it as thin as
possible. For example, clean up all intermediate files:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget xxx.zip
<span class="c1"># Unzip, make, make install</span>
rm -fr xxx.zip xxx
</pre></div>
</div>
</li>
<li><p>Cross-architecture.</p>
<p>It would be awesome to work perfectly for different architectures such as
<code class="docutils literal notranslate"><span class="pre">x86_64</span></code> and <code class="docutils literal notranslate"><span class="pre">aarch64</span></code>.</p>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../CONTRIBUTING.html" class="btn btn-neutral float-left" title="How to Contribute to Apollo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="../setup_host/README.html" class="btn btn-neutral float-right" title="Host Setup" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2021, xinetzone.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>