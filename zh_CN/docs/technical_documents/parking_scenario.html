<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PARKING SCENARIO &mdash; Apollo Auto alpha 文档</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/cyber/doxy-docs/source/main_stylesheet.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/tabs.js"></script>
        <script src="../../_static/translations.js"></script>
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="Planning Component Introduction" href="planning_component.html" />
    <link rel="prev" title="GENERATE FINAL TRAJECTORY" href="open_space_trajectory_provider_en.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: skyblue" >
            <a href="../../index.html" class="icon icon-home"> Apollo Auto
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="在文档中搜索" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Apollo Auto 自述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../README.html">Apollo Auto 文档</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cyber/doxy-docs/source/index.html">cyber 文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: skyblue" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apollo Auto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>PARKING SCENARIO</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/docs/technical_documents/parking_scenario.md.txt" rel="nofollow"> 查看页面源码</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="parking-scenario">
<h1>PARKING SCENARIO<a class="headerlink" href="#parking-scenario" title="永久链接至标题"></a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="永久链接至标题"></a></h1>
<p>Apollo planning is scenario based, where each driving use case is treated as a different driving scenario.</p>
<p>There are three scenairos, park and go, pull over and valet parking, which related to park planning.</p>
<ol class="simple">
<li><p>park and go: the park and go scenario was designed to handle curb side parking, planning a new trajectory to the next destination and then driving along that trajectory. This scenario is extremely useful in situations like curb-side delivery or passenger pickup or drop-off.</p></li>
<li><p>pull over: the pull over scenario was designed especially for maneuvering to the side of the road upon reaching your destination like for curb-side parallel parking.</p></li>
<li><p>valet parking: the valet parking scenario was designed to safely park your ego car in a targeted parking spot.</p></li>
</ol>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="where-is-the-code">
<h1>Where is the code<a class="headerlink" href="#where-is-the-code" title="永久链接至标题"></a></h1>
<p>Please refer <a class="reference external" href="https://github.com/ApolloAuto/apollo/modules/planning/scenarios/park/">park</a> &amp; <a class="reference external" href="https://github.com/ApolloAuto/apollo/modules/planning/scenarios/park_and_go/">park and go</a>.</p>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="code-reading">
<h1>Code Reading<a class="headerlink" href="#code-reading" title="永久链接至标题"></a></h1>
<p>All three scenarios contain specific stages, the function of scenarios are realized through the conversion of stages. Thus, figure out the process of stages conversion is the key to understand this code.</p>
<section id="park-and-go-scenario">
<h2>PARK AND GO SCENARIO<a class="headerlink" href="#park-and-go-scenario" title="永久链接至标题"></a></h2>
<ol>
<li><p>This scenario consists of four stages, check stage, adjust stage, pre cruise stage and cruise stage.</p></li>
<li><p>check stage:</p>
<ol class="simple">
<li><p>In check stage, by calling <code class="docutils literal notranslate"><span class="pre">checkadcreadytocruise()</span></code>to check whether ADC’s gear info, ADC’s velocity, obstacle position, ADC’s heading and ADC’s lateral station meet the requirements.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckADCReadyToCruise</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">VehicleStateProvider</span><span class="o">*</span><span class="w"> </span><span class="n">vehicle_state_provider</span><span class="p">,</span><span class="w"> </span><span class="n">Frame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">,</span><span class="w"></span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">ScenarioParkAndGoConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">scenario_config</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If ADC is ready to cruise, check stage is finished and we switch to cruise stage. Otherwise we switch to adjust stage.</p></li>
</ol>
</li>
<li><p>adjust stage:</p>
<ol class="simple">
<li><p>In adjust stage, we run open space planning algorithms to adjust ADC position.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExecuteTaskOnOpenSpace</span><span class="p">(</span><span class="n">Frame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>Once position adjustment is done, we check whether ADC reaches the end of trajectory.</p></li>
<li><p>Then we check whether ADC is ready to cruise by calling <code class="docutils literal notranslate"><span class="pre">CheckADCReadyToCruise()</span></code>.</p></li>
<li><p>If ADC is ready to cruise and reaches the end of trajectory, adjust stage is finished.</p>
<ol class="simple">
<li><p>If steering percentage within the threshold, we switch to cruise stage.</p></li>
<li><p>Otherwise we reset init position of ADC and switch to pre cruise stage.</p></li>
</ol>
</li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="nf">ResetInitPostion</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>Otherwise ADC stay in adjust stage to adjust ADC position.</p></li>
</ol>
</li>
<li><p>pre cruise stage:</p>
<ol class="simple">
<li><p>In pre cruise stage, we run open space planning algorithms to adjust ADC with the init position.</p></li>
<li><p>Then we check whether the steering percentage within the threshold.</p></li>
<li><p>If so, pre cruise stage is finished and we switch to cruise stage.</p></li>
<li><p>Otherwise ADC stay in pre cruise stage.</p></li>
</ol>
</li>
<li><p>cruise stage:</p>
<ol class="simple">
<li><p>We run an on lane planning algorithms to adjust ADC position.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">ExecuteTaskOnReferenceLine</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">TrajectoryPoint</span><span class="o">&amp;</span><span class="w"> </span><span class="n">planning_start_point</span><span class="p">,</span><span class="w"> </span><span class="n">Frame</span><span class="o">*</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w">         </span>
</pre></div>
</div>
<ol class="simple">
<li><p>Then we check whether the lateral distacne between ADC and target line within the threshold.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="n">ParkAndGoStatus</span><span class="w"> </span><span class="nf">CheckADCParkAndGoCruiseCompleted</span><span class="p">(</span><span class="w"></span>
<span class="w">         </span><span class="k">const</span><span class="w"> </span><span class="n">ReferenceLineInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference_line_info</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If so, cruise stage is finished and quit park and go scenario is done.</p></li>
<li><p>Otherwise ADC stay in cruise stage until ADC cruises to a desired position.</p></li>
<li><p>The conversion of stages can be seen in
<img alt="Diagram" src="../../_images/parking_scenairo_fig_1.png" />.</p></li>
</ol>
</li>
</ol>
</section>
<section id="pull-over-scenario">
<h2>PULL OVER SCENARIO<a class="headerlink" href="#pull-over-scenario" title="永久链接至标题"></a></h2>
<ol>
<li><p>This scenario consists of three stages, approach stage, retry approach parking stage and retry parking stage.</p></li>
<li><p>approach stage:</p>
<ol class="simple">
<li><p>We run an on lane planning algorithms to approach pull over target position.</p></li>
<li><p>At first, we check path points data to see whether the s, l and theta error between ADC and the target path point within the threshold.</p>
<ol class="simple">
<li><p>If so, the pull over status is set to PARK_COMPLETE.</p></li>
<li><p>Otherwise we add a stop fence for adc to pause at a better position.</p></li>
<li><p>However, if we can’t find a suitable new stop fence, approach stage is finished and we switch to retry appoach parking stage.</p></li>
</ol>
</li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="n">PullOverStatus</span><span class="w"> </span><span class="nf">CheckADCPullOverPathPoint</span><span class="p">(</span><span class="w"></span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">ReferenceLineInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference_line_info</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">ScenarioPullOverConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">scenario_config</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">PathPoint</span><span class="o">&amp;</span><span class="w"> </span><span class="n">path_point</span><span class="p">,</span><span class="w"></span>
<span class="w">          </span><span class="k">const</span><span class="w"> </span><span class="n">PlanningContext</span><span class="o">*</span><span class="w"> </span><span class="n">planning_context</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>Then we check whether adc parked properly.</p>
<ol class="simple">
<li><p>If ADC pass the destination or park properly, approach stage is finished and pull over scenario is done.</p></li>
<li><p>If adc park failed, approach stage is finished and we switch to retry appoach parking stage.</p></li>
</ol>
</li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="n">PullOverStatus</span><span class="w"> </span><span class="nf">CheckADCPullOver</span><span class="p">(</span><span class="w"></span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">common</span><span class="o">::</span><span class="n">VehicleStateProvider</span><span class="o">*</span><span class="w"> </span><span class="n">vehicle_state_provider</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">ReferenceLineInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">reference_line_info</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">ScenarioPullOverConfig</span><span class="o">&amp;</span><span class="w"> </span><span class="n">scenario_config</span><span class="p">,</span><span class="w"></span>
<span class="w">       </span><span class="k">const</span><span class="w"> </span><span class="n">PlanningContext</span><span class="o">*</span><span class="w"> </span><span class="n">planning_context</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>retry approach parking stage:</p>
<ol class="simple">
<li><p>We run an on lane planning algorithms to reach the stop line of open space planner.</p></li>
<li><p>Check whether ADC stop properly.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckADCStop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="o">&amp;</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If so, retry approach parking stage is finished and switch to retry parking stage.</p></li>
</ol>
</li>
<li><p>retry parking stage:</p>
<ol class="simple">
<li><p>We run an open space planning algorithms to park.</p></li>
<li><p>Check whether ADC park properly(check distance and theta diff).</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckADCPullOverOpenSpace</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If so, retry parking stage is finished and pull over scenario is done.</p></li>
<li><p>Otherwise ADC stay in the stage until ADC park properly.</p></li>
<li><p>The conversion of stages can be seen in
<img alt="Diagram" src="../../_images/parking_scenairo_fig_2.png" />.</p></li>
</ol>
</li>
</ol>
</section>
<section id="valet-parking-scenario">
<h2>VALET PARKING SCENARIO<a class="headerlink" href="#valet-parking-scenario" title="永久链接至标题"></a></h2>
<ol>
<li><p>This scenario consists of two stages, approach parking spot stage and parking stage.</p></li>
<li><p>approach parking spot stage:</p>
<ol class="simple">
<li><p>We run an on lane planning algorithms to approach the designated parking spot.</p></li>
<li><p>ADC cruises to a halt once it has found the right stopping point required in order to reverse into the parking spot.</p></li>
</ol>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="w">     </span><span class="kt">bool</span><span class="w"> </span><span class="nf">CheckADCStop</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Frame</span><span class="o">&amp;</span><span class="w"> </span><span class="n">frame</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<ol class="simple">
<li><p>If stop properly, approach parking spot stage is finished and switch to parking stage.</p></li>
<li><p>Otherwise ADC stay in the stage until it approaches to desired parking spot.</p></li>
</ol>
</li>
<li><p>parking stage:</p>
<ol class="simple">
<li><p>Open Space Planner algorithm is used to generate a zig-zag trajectory which involves both forward and reverse driving (gear changes) in order to safely park the ego car.</p></li>
<li><p>The conversion of stages can be seen in
<img alt="Diagram" src="../../_images/parking_scenairo_fig_3.png" />.</p></li>
</ol>
</li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="open_space_trajectory_provider_en.html" class="btn btn-neutral float-left" title="GENERATE FINAL TRAJECTORY" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="planning_component.html" class="btn btn-neutral float-right" title="Planning Component Introduction" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2021, xinetzone.</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用了 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a>开发.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>